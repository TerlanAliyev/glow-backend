<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lyra Super Test Client (All Features)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f5f5f7;
            color: #1d1d1f;
            padding: 20px;
            max-width: 800px;
            margin: auto;
        }

        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        h1,
        h2 {
            color: #000;
        }

        h1#currentUser {
            text-align: center;
            color: #007aff;
            min-height: 40px;
        }

        input,
        textarea,
        button {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }

        button {
            background-color: #007aff;
            color: white;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #005bb5;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        #logs {
            background-color: #e5e5ea;
            padding: 15px;
            border-radius: 8px;
            height: 200px;
            overflow-y: scroll;
            font-family: 'SF Mono', 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }

        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: 600;
            display: inline-block;
        }

        .status.disconnected {
            background-color: #ff3b30;
            color: white;
        }

        .status.connected {
            background-color: #34c759;
            color: white;
        }

        #compassResults,
        #connections {
            min-height: 50px;
            padding: 15px;
            border: 2px dashed #007aff;
            border-radius: 8px;
        }

        .user-card {
            background-color: #f5f5f7;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .signal-btn {
            width: auto;
            padding: 5px 10px;
            font-size: 12px;
            margin-left: 10px;
            background-color: #ff9500;
        }

        .connection-card {
            background-color: #e0ffe8;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 5px;
            border-left: 5px solid #34c759;
            cursor: pointer;
        }

        #chatRoom,
        #groupChatRoom {
            display: none;
        }

        #chatMessages,
        #groupChatMessages {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .message,
        .group-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.sent {
            background-color: #007aff;
            color: white;
            margin-left: auto;
            text-align: left;
        }

        .message.received {
            background-color: #e5e5ea;
        }

        .sender {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #6c757d;
        }

        #typingIndicator,
        #groupTypingIndicator {
            color: #8e8e93;
            font-style: italic;
            padding: 5px 10px;
            height: 20px;
            transition: opacity 0.3s;
        }

        .read-receipt {
            font-size: 11px;
            color: #a9d1ff;
            display: inline-block;
            margin-left: 8px;
        }

        #icebreaker-suggestions {
            padding-top: 10px;
            border-top: 1px solid #e5e5ea;
            margin-top: 10px;
        }

        .suggestion-btn {
            width: auto;
            padding: 8px 12px;
            margin: 0 8px 8px 0;
            background-color: #f0f0f5;
            color: #007aff;
            border: 1px solid #007aff;
            cursor: pointer;
            border-radius: 20px;
            font-size: 14px;
        }

        .group-message {
            background-color: #f2f2f7;
        }

        .group-message .sender {
            color: #007aff;
        }

        .group-message-own {
            background-color: #e5e5ea;
            margin-left: auto;
        }

        .chat-image {
            max-width: 200px;
            border-radius: 12px;
            margin-top: 5px;
        }

        .upload-area {
            display: flex;
            align-items: center;
        }

        .upload-area input[type="file"] {
            flex-grow: 1;
        }

        .reactions {
            position: absolute;
            top: -25px;
            /* Mesajƒ±n biraz √ºst√ºnd…ô */
            left: 5px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            display: flex;
            padding: 2px;
            opacity: 0;
            /* Standart olaraq gizli */
            transition: opacity 0.2s;
            pointer-events: none;
            /* Klikl…ônm…ôsin */
        }

        /* D√úZ∆èLƒ∞≈û BURADADIR: Artƒ±q birba≈üa mesajƒ±n √∂z√ºn…ô hover edirik */
        .group-message:hover .reactions {
            opacity: 1;
            /* √úz…ôrin…ô g…ôl…ônd…ô g√∂r√ºn…ôn et */
            pointer-events: auto;
            /* Klikl…ôn…ô bil…ôn et */
        }

        .reaction-emoji {
            cursor: pointer;
            padding: 2px 4px;
            font-size: 16px;
        }

        .reaction-display {
            position: absolute;
            bottom: -5px;
            right: 10px;
            background: #e5e5ea;
            border-radius: 10px;
            padding: 1px 5px;
            font-size: 12px;
        }

        .message-container {
            position: relative;
            margin-bottom: 10px;
        }

        .message,
        .group-message {
            padding: 8px 12px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            display: inline-block;
            position: relative;
            /* Vacibdir */
        }

        .message-container.sent {
            text-align: right;
        }

        .message.sent {
            background-color: #007aff;
            color: white;
            text-align: left;
        }

        .message.received,
        .group-message {
            background-color: #e5e5ea;
        }
    </style>
</head>

<body>

    <h1 id="currentUser">Lyra Super Test Client (All Features)</h1>
    <p style="text-align: center;">Status: <span id="status" class="status disconnected">Disconnected</span></p>

    <div class="container">
        <h2>1. Qo≈üulma</h2>
        <input type="text" id="serverUrl" value="http://localhost:3000">
        <textarea id="authToken" placeholder="..."></textarea>
        <button id="connectBtn">Connect</button>
        <button id="disconnectBtn" style="display:none">Disconnect</button>
    </div>

    <div class="container" id="actions" style="display:none">
        <h2>2. ∆èm…ôliyyatlar</h2>
        <h4>Addƒ±m 1: Check-in</h4>
        <div class="grid-2">
            <input type="number" id="latitude" value="40.3777">
            <input type="number" id="longitude" value="49.8344">
        </div>
        <button id="checkInBtn">Check-in</button>

        <hr>

        <h4>Addƒ±m 2: M…ôkana Qo≈üul</h4>
        <input type="number" id="venueId" placeholder="Venue ID...">
        <div class="grid-2">
            <input type="number" id="minAge" placeholder="Min. Ya≈ü">
            <input type="number" id="maxAge" placeholder="Maks. Ya≈ü">
        </div>
        <input type="text" id="interestIds" placeholder="Maraq ID-l…ôri...">
        <button id="joinVenueBtn">Join Venue</button>
    </div>

    <div class="container" id="groupChatRoom">
        <h2>M…ôkanƒ±n √úmumi S√∂hb…ôti</h2>
        <div id="groupChatMessages"></div>
        <div id="groupTypingIndicator"></div>
        <textarea id="groupMessageInput" placeholder="..."></textarea>
        <button id="sendGroupMessageBtn">G√∂nd…ôr</button>
        <div class="upload-area">
            <input type="file" id="groupImageInput" accept="image/*">
            <button id="sendGroupImageBtn" style="width: auto; padding: 12px 20px;">≈û…ôkil G√∂nd…ôr</button>
        </div>
    </div>

    <div class="container">
        <h2>3. Kompas N…ôtic…ôl…ôri</h2>
        <div id="compassResults">
            <p>...</p>
        </div>
    </div>

    <div class="container">
        <h2>4. Yeni Baƒülantƒ±lar (Matches)</h2>
        <div id="connections">
            <p>...</p>
        </div>
    </div>

    <div class="container" id="chatRoom">
        <h2 id="chatWith">... il…ô s√∂hb…ôt</h2>
        <div id="chatMessages" onclick="markMessagesAsRead()"></div>
        <div id="typingIndicator"></div>
        <div id="icebreaker-suggestions"></div>
        <textarea id="messageInput" placeholder="..."></textarea>
        <button id="sendMessageBtn">G√∂nd…ôr</button>
        <hr>
        <div class="upload-area">
            <input type="file" id="imageInput" accept="image/*">
            <button id="sendImageBtn" style="width: auto; padding: 12px 20px;">≈û…ôkil G√∂nd…ôr</button>
        </div>
        <div class="audio-recorder">
            <button id="recordBtn" style="background-color: #ff3b30;">S…ôs Yaz</button>
            <button id="stopBtn" style="display:none; background-color: #34c759;">Dayandƒ±r & G√∂nd…ôr</button>
            <audio id="audioPlayer" controls style="display:none; width: 100%;"></audio>
        </div>
    </div>

    <div class="container">
        <h2 style="margin-top: 20px;">Texniki Loqlar</h2>
        <div id="logs"></div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let socket, currentUser, currentConnection, mediaRecorder, audioChunks = [];
            let typingTimeout = null, groupTypingTimeout = null;
            let compassUsers = [], groupTypingUsers = {}, groupReactions = {};

            // E2EE √º√ß√ºn istifad…ô olunacaq statik a√ßar
            const E2EE_KEY = "gizli-ve-guclu-acar";

            const elements = {
                status: document.getElementById('status'),
                connectBtn: document.getElementById('connectBtn'),
                disconnectBtn: document.getElementById('disconnectBtn'),
                actions: document.getElementById('actions'),
                logs: document.getElementById('logs'),
                compassResults: document.getElementById('compassResults'),
                authToken: document.getElementById('authToken'),
                currentUser: document.getElementById('currentUser'),
                sendMessageBtn: document.getElementById('sendMessageBtn'),
                messageInput: document.getElementById('messageInput'),
                typingIndicator: document.getElementById('typingIndicator'),
                chatMessages: document.getElementById('chatMessages'),
                icebreakerSuggestions: document.getElementById('icebreaker-suggestions'),
                groupChatRoom: document.getElementById('groupChatRoom'),
                groupChatMessages: document.getElementById('groupChatMessages'),
                groupMessageInput: document.getElementById('groupMessageInput'),
                sendGroupMessageBtn: document.getElementById('sendGroupMessageBtn'),
                groupTypingIndicator: document.getElementById('groupTypingIndicator'),
                serverUrl: document.getElementById('serverUrl'),
                venueId: document.getElementById('venueId'),
                checkInBtn: document.getElementById('checkInBtn'),
                joinVenueBtn: document.getElementById('joinVenueBtn'),
                connections: document.getElementById('connections'),
                chatRoom: document.getElementById('chatRoom'),
                chatWith: document.getElementById('chatWith'),
                imageInput: document.getElementById('imageInput'),
                sendImageBtn: document.getElementById('sendImageBtn'),
                groupImageInput: document.getElementById('groupImageInput'),
                sendGroupImageBtn: document.getElementById('sendGroupImageBtn'),
                recordBtn: document.getElementById('recordBtn'),
                stopBtn: document.getElementById('stopBtn'),
                audioPlayer: document.getElementById('audioPlayer')
            };

            // --- K√ñM∆èK√áƒ∞ FUNKSƒ∞YALAR ---
            function log(message, type = '') {
                const entry = document.createElement('div');
                entry.className = `log-entry ${type}`;
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                elements.logs.appendChild(entry);
                elements.logs.scrollTop = elements.logs.scrollHeight;
            }

            // D√úZ∆èLƒ∞≈û: Mesajƒ± a√ßmaq √º√ß√ºn funksiya
            function decryptMessageContent(encryptedContent) {
                try {
                    if (!encryptedContent) return "";
                    const bytes = CryptoJS.AES.decrypt(encryptedContent, E2EE_KEY);
                    return bytes.toString(CryptoJS.enc.Utf8);
                } catch (e) {
                    console.error("Mesajƒ±n ≈üifr…ôsi a√ßƒ±la bilm…ôdi:", e);
                    return "≈ûifr…ôsi a√ßƒ±la bilm…ôy…ôn mesaj";
                }
            }

            function renderCompass() {
                elements.compassResults.innerHTML = '';
                if (compassUsers.length > 0) {
                    const header = document.createElement('h3');
                    header.textContent = `Bu m…ôkanda ${compassUsers.length} n…ôf…ôr tapƒ±ldƒ±:`;
                    elements.compassResults.appendChild(header);
                    compassUsers.forEach(user => {
                        if (!user || !user.userId) return;
                        const userCard = document.createElement('div');
                        userCard.className = 'user-card';
                        userCard.innerHTML = `<span><img src="${user.avatarUrl || ''}" width="30" height="30" style="border-radius: 50%; margin-right: 10px; object-fit: cover; background-color: #eee;"><strong>${user.name || 'N/A'}</strong> (Score: ${user.compatibilityScore})</span>`;
                        const signalBtn = document.createElement('button');
                        signalBtn.className = 'signal-btn';
                        signalBtn.textContent = 'Siqnal G√∂nd…ôr';
                        signalBtn.onclick = () => {
                            socket.emit('send_signal', { receiverId: user.userId });
                            signalBtn.disabled = true;
                            signalBtn.textContent = 'G√∂nd…ôrildi';
                        };
                        userCard.appendChild(signalBtn);
                        elements.compassResults.appendChild(userCard);
                    });
                } else {
                    elements.compassResults.innerHTML = '<p>Filtrl…ôr…ô uyƒüun he√ß kim tapƒ±lmadƒ± v…ô ya m…ôkanda ba≈üqa kims…ô yoxdur.</p>';
                }
            }

            // D√úZ∆èLƒ∞≈û: Mesajlarƒ± render ed…ôrk…ôn decrypt edirik
            function appendMessage(msg, isHistory = false) {
                const msgDiv = document.createElement('div');
                msgDiv.className = 'message';
                msgDiv.id = `msg-${msg.id}`;
                let contentHtml = '';
                // ≈ûifr…ôli m…ôzmunu a√ßƒ±rƒ±q
                const decryptedContent = decryptMessageContent(msg.content);

                if (decryptedContent) {
                    contentHtml += `<div>${decryptedContent}</div>`;
                }
                if (msg.imageUrl) {
                    contentHtml += `<img src="${msg.imageUrl}" class="chat-image" alt="S√∂hb…ôt ≈ü…ôkli" onclick="window.open('${msg.imageUrl}', '_blank')">`;
                }
                if (msg.audioUrl) {
                    contentHtml += `<audio controls src="${msg.audioUrl}"></audio>`;
                }
                if (currentUser && msg.senderId === currentUser.id) {
                    msgDiv.classList.add('sent');
                    msgDiv.innerHTML = `${contentHtml}<span class="read-receipt" id="receipt-msg-${msg.id}">‚úì</span>`;
                } else {
                    msgDiv.classList.add('received');
                    let senderHtml = msg.sender?.profile?.name ? `<div class="sender">${msg.sender.profile.name}</div>` : '';
                    msgDiv.innerHTML = `${senderHtml}${contentHtml}`;
                }

                if (isHistory) {
                    elements.chatMessages.prepend(msgDiv);
                } else {
                    elements.chatMessages.appendChild(msgDiv);
                    elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
                }
            }

            // D√úZ∆èLƒ∞≈û: Qrup mesajlarƒ±nƒ± render ed…ôrk…ôn decrypt edirik
            function appendGroupMessage(msg) {
                const msgContainer = document.createElement('div');
                msgContainer.className = 'message-container';

                const msgDiv = document.createElement('div');
                msgDiv.className = 'group-message';
                msgDiv.id = `group-msg-${msg.id}`;

                if (msg.isSystemWarning) {
                    msgDiv.style.backgroundColor = '#fff0f0';
                    msgDiv.style.border = '1px solid #ff3b30';
                    msgDiv.innerHTML = `<div class="sender" style="color: #ff3b30;">‚ö†Ô∏è ${msg.sender.profile.name}</div><div>${msg.content}</div>`;
                    msgContainer.appendChild(msgDiv);
                    elements.groupChatMessages.appendChild(msgContainer);
                    elements.groupChatMessages.scrollTop = elements.groupChatMessages.scrollHeight;
                    return;
                }

                const decryptedContent = decryptMessageContent(msg.content);

                let senderName = msg.sender?.profile?.name || 'Bilinm…ôy…ôn';
                if (currentUser && msg.senderId === currentUser.id) {
                    senderName = 'Siz';
                    msgContainer.classList.add('sent');
                    msgDiv.classList.add('group-message-own');
                }

                let contentHtml = `<div class="sender">${senderName}</div>`;
                if (decryptedContent) contentHtml += `<div>${decryptedContent}</div>`;
                if (msg.imageUrl) contentHtml += `<img src="${msg.imageUrl}" style="max-width: 200px; border-radius: 12px;">`;
                msgDiv.innerHTML = contentHtml;

                const reactionsDiv = document.createElement('div');
                reactionsDiv.className = 'reactions';
                ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üî•'].forEach(emoji => {
                    const emojiSpan = document.createElement('span');
                    emojiSpan.className = 'reaction-emoji';
                    emojiSpan.textContent = emoji;
                    emojiSpan.onclick = () => {
                        socket.emit('send_group_reaction', { venueId: elements.venueId.value, messageId: msg.id, reactionEmoji: emoji });
                    };
                    reactionsDiv.appendChild(emojiSpan);
                });
                msgDiv.appendChild(reactionsDiv);

                const reactionDisplayDiv = document.createElement('div');
                reactionDisplayDiv.className = 'reaction-display';
                reactionDisplayDiv.id = `reaction-display-${msg.id}`;

                if (msg.reactions && msg.reactions.length > 0) {
                    // ... (reaksiya g√∂st…ôrm…ô m…ôntiqi)
                } else {
                    reactionDisplayDiv.style.display = 'none';
                }

                msgContainer.appendChild(msgDiv);
                msgContainer.appendChild(reactionDisplayDiv);
                elements.groupChatMessages.appendChild(msgContainer);
                elements.groupChatMessages.scrollTop = elements.groupChatMessages.scrollHeight;
            }

            function updateGroupTypingIndicator() {
                const userNames = Object.values(groupTypingUsers);
                if (userNames.length === 0) {
                    elements.groupTypingIndicator.textContent = '';
                } else if (userNames.length === 1) {
                    elements.groupTypingIndicator.textContent = `${userNames[0]} yazƒ±r...`;
                } else if (userNames.length === 2) {
                    elements.groupTypingIndicator.textContent = `${userNames.join(' v…ô ')} yazƒ±r...`;
                } else {
                    elements.groupTypingIndicator.textContent = 'Bir ne√ß…ô n…ôf…ôr yazƒ±r...';
                }
            }

            window.markMessagesAsRead = () => {
                if (socket && currentConnection) {
                    log('SENT EVENT "mark_as_read"', 'sent');
                    socket.emit('mark_as_read', { connectionId: currentConnection.connection.id });
                }
            };

            // --- EVENT Lƒ∞STENERLERƒ∞ ---
            elements.connectBtn.addEventListener('click', () => {
                const token = elements.authToken.value;
                if (!token) return log('X∆èTA: Token daxil edin!', 'error');

                socket = io(elements.serverUrl.value, { auth: { token } });

                socket.on('connect', () => {
                    elements.status.textContent = 'Connected';
                    elements.status.className = 'status connected';
                    elements.connectBtn.style.display = 'none';
                    elements.disconnectBtn.style.display = 'block';
                    elements.actions.style.display = 'block';
                    log('Server…ô uƒüurla qo≈üuldu!', 'received');
                });

                socket.on('disconnect', () => {
                    elements.status.textContent = 'Disconnected';
                    elements.status.className = 'status disconnected';
                    elements.connectBtn.style.display = 'block';
                    elements.disconnectBtn.style.display = 'none';
                    elements.actions.style.display = 'none';
                    log('Serverd…ôn ayrƒ±ldƒ±.', 'error');
                });

                socket.on('error', (data) => log(`ERROR: ${JSON.stringify(data)}`, 'error'));

                socket.on('receive_venue_group_message', (message) => {
                    log(`GROUP_MESSAGE from ${message.sender.profile.name}: ${message.content}`, 'received');
                    appendGroupMessage(message);
                });

                socket.on('compass_update', (users) => {
                    compassUsers = users;
                    renderCompass();
                });

                socket.on('user_joined', (newUser) => {
                    if (!compassUsers.some(u => u.userId === newUser.userId)) {
                        compassUsers.push(newUser);
                        renderCompass();
                    }
                });

                socket.on('new_connection', async (data) => {
                    currentConnection = data;
                    elements.chatWith.textContent = `${data.partner.name} il…ô s√∂hb…ôt`;
                    elements.chatRoom.style.display = 'block';
                    elements.chatMessages.innerHTML = '';
                    elements.icebreakerSuggestions.innerHTML = '';

                    try {
                        // D√úZ∆èLƒ∞≈û: connectionId-ni d√ºzg√ºn g√∂nd…ôririk.
                        const history = await fetch(`${elements.serverUrl.value}/api/chat/${data.connection.id}/messages`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        }).then(res => res.json());

                        if (history && history.data && history.data.length > 0) {
                            history.data.forEach(msg => appendMessage(msg, true));
                        } else {
                            const questions = await fetch(`${elements.serverUrl.value}/api/chat/icebreakers`, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            }).then(res => res.json());

                            if (questions && questions.length > 0) {
                                elements.icebreakerSuggestions.innerHTML = '<h5>S√∂hb…ôt…ô ba≈üla:</h5>';
                                questions.forEach(q => {
                                    const btn = document.createElement('button');
                                    btn.className = 'suggestion-btn';
                                    btn.innerText = q.text;
                                    btn.onclick = () => {
                                        elements.messageInput.value = q.text;
                                        elements.icebreakerSuggestions.style.display = 'none';
                                        elements.messageInput.focus();
                                    };
                                    elements.icebreakerSuggestions.appendChild(btn);
                                });
                            }
                        }
                    } catch (error) {
                        log(`API X∆èTASI: ${error.message}`, 'error');
                    }
                });

                socket.on('user_is_group_typing', ({ userId, userName }) => {
                    groupTypingUsers[userId] = userName;
                    updateGroupTypingIndicator();
                });

                socket.on('user_stopped_group_typing', ({ userId }) => {
                    delete groupTypingUsers[userId];
                    updateGroupTypingIndicator();
                });

                socket.on('receive_message', (message) => {
                    if (currentConnection && message.connectionId === currentConnection.connection.id) {
                        appendMessage(message);
                        elements.typingIndicator.style.opacity = 0;
                    }
                });

                socket.on('user_is_typing', ({ connectionId }) => {
                    if (currentConnection && connectionId === currentConnection.connection.id) {
                        elements.typingIndicator.innerText = `${currentConnection.partner.name} yazƒ±r...`;
                        elements.typingIndicator.style.opacity = 1;
                    }
                });

                socket.on('user_stopped_typing', ({ connectionId }) => {
                    if (currentConnection && connectionId === currentConnection.connection.id) {
                        elements.typingIndicator.style.opacity = 0;
                    }
                });

                socket.on('messages_were_read', ({ connectionId }) => {
                    if (currentConnection && connectionId === currentConnection.connection.id) {
                        log('Partner mesajlarƒ± oxudu!', 'received');
                        document.querySelectorAll('.read-receipt').forEach(el => {
                            el.innerText = '‚úì‚úì';
                            el.style.color = '#4ade80';
                        });
                    }
                });
                socket.on('update_group_reactions', ({ messageId, reactions }) => {
                    log(`RECEIVED reaction update for msg ${messageId}`, 'received');
                    const displayDiv = document.getElementById(`reaction-display-${messageId}`);
                    if (displayDiv) {
                        const reactionCounts = reactions.reduce((acc, r) => { acc[r.emoji] = (acc[r.emoji] || 0) + 1; return acc; }, {});
                        const reactionText = Object.entries(reactionCounts).map(([e, c]) => `${e} ${c}`).join(' ');
                        displayDiv.textContent = reactionText;
                        displayDiv.style.display = reactionText ? 'inline-block' : 'none';
                    }
                });

                socket.on('moderation_warning', (data) => {
                    log(`MODERATION WARNING: ${data.message}`, 'error');
                    alert(`X∆èB∆èRDARLIQ: ${data.message}`);
                });

            });

            elements.disconnectBtn.addEventListener('click', () => {
                if (socket) {
                    socket.disconnect();
                }
            });

            elements.checkInBtn.addEventListener('click', async () => {
                const token = elements.authToken.value;
                try {
                    const response = await fetch(`${elements.serverUrl.value}/api/location/check-in`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({
                            latitude: parseFloat(elements.latitude.value),
                            longitude: parseFloat(elements.longitude.value)
                        })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message);
                    if (data.data?.venueId) elements.venueId.value = data.data.venueId;
                    log('Check-in uƒüurla tamamlandƒ±!', 'received');
                } catch (error) {
                    log(`API X∆èTASI: ${error.message}`, 'error');
                }
            });

            elements.joinVenueBtn.addEventListener('click', async () => {
                const venueId = elements.venueId.value;
                if (!socket || !venueId) return log('X∆èTA: Venue ID daxil edin!', 'error');

                elements.groupChatRoom.style.display = 'block';
                elements.groupChatMessages.innerHTML = '';

                try {
                    const history = await fetch(`${elements.serverUrl.value}/api/chat/venue/${venueId}/messages`, {
                        headers: { 'Authorization': `Bearer ${elements.authToken.value}` }
                    }).then(res => res.json());
                    if (history) history.forEach(appendGroupMessage);
                } catch (error) {
                    log(`Qrup mesaj tarix√ß…ôsi y√ºkl…ôn…ô bilm…ôdi: ${error.message}`, 'error');
                }

                socket.emit('join_venue', Number(venueId), {});
            });

            // D√úZ∆èLƒ∞≈û: Mesaj g√∂nd…ôrm…ô butonu
            elements.sendMessageBtn.addEventListener('click', () => {
                const content = elements.messageInput.value.trim();
                if (!currentConnection || !content) return;
                const encryptedContent = CryptoJS.AES.encrypt(content, E2EE_KEY).toString();
                socket.emit('send_message', { connectionId: currentConnection.connection.id, encryptedContent: encryptedContent });
                elements.messageInput.value = '';
                if (typingTimeout) {
                    clearTimeout(typingTimeout);
                    socket.emit('stop_typing', { connectionId: currentConnection.connection.id });
                    typingTimeout = null;
                }
            });

            // D√úZ∆èLƒ∞≈û: Qrup mesajƒ± g√∂nd…ôrm…ô butonu
            elements.sendGroupMessageBtn.addEventListener('click', () => {
                const content = elements.groupMessageInput.value.trim();
                const venueId = elements.venueId.value;
                if (!socket || !venueId || !content) return;

                const encryptedContent = CryptoJS.AES.encrypt(content, E2EE_KEY).toString();

                socket.emit('send_venue_group_message', { venueId: Number(venueId), encryptedContent: encryptedContent });

                elements.groupMessageInput.value = '';
                if (groupTypingTimeout) {
                    clearTimeout(groupTypingTimeout);
                    socket.emit('stop_group_typing', { venueId: Number(venueId) });
                    groupTypingTimeout = null;
                }
            });

            elements.messageInput.addEventListener('input', () => {
                if (socket && currentConnection) {
                    if (!typingTimeout) {
                        socket.emit('start_typing', { connectionId: currentConnection.connection.id });
                    }
                    clearTimeout(typingTimeout);
                    typingTimeout = setTimeout(() => {
                        socket.emit('stop_typing', { connectionId: currentConnection.connection.id });
                        typingTimeout = null;
                    }, 2000);
                }
            });

            elements.messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    elements.sendMessageBtn.click();
                }
            });

            elements.groupMessageInput.addEventListener('input', () => {
                const venueId = elements.venueId.value;
                if (socket && venueId) {
                    if (!groupTypingTimeout) {
                        socket.emit('start_group_typing', { venueId: Number(venueId) });
                    }
                    clearTimeout(groupTypingTimeout);
                    groupTypingTimeout = setTimeout(() => {
                        socket.emit('stop_group_typing', { venueId: Number(venueId) });
                        groupTypingTimeout = null;
                    }, 2000);
                }
            });

            elements.groupMessageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    elements.sendGroupMessageBtn.click();
                }
            });

            // D√úZ∆èLƒ∞≈û: ≈û…ôkil g√∂nd…ôrm…ô
            elements.sendImageBtn.addEventListener('click', async () => {
                const file = imageInput.files[0];
                if (!file || !currentConnection) {
                    log('Z…ôhm…ôt olmasa, ≈ü…ôkil se√ßin v…ô bir s√∂hb…ôtd…ô olun.', 'error');
                    return;
                }

                sendImageBtn.disabled = true;
                log('≈û…ôkil Cloudinary-…ô y√ºkl…ônir...', 'sent');
                const formData = new FormData();
                formData.append('chatImage', file);

                try {
                    const response = await fetch(`${elements.serverUrl.value}/api/chat/upload-image`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${elements.authToken.value}` },
                        body: formData
                    });
                    const result = await response.json();

                    if (!response.ok) throw new Error(result.message);

                    log('≈û…ôkil y√ºkl…ôndi. Mesaj g√∂nd…ôrilir...', 'sent');
                    socket.emit('send_message', {
                        connectionId: currentConnection.connection.id,
                        imageUrl: result.url
                    });

                    imageInput.value = '';
                } catch (error) {
                    log(`≈û…ôkil g√∂nd…ôril…ôrk…ôn x…ôta: ${error.message}`, 'error');
                } finally {
                    sendImageBtn.disabled = false;
                }
            });

            // D√úZ∆èLƒ∞≈û: Qrup ≈ü…ôkli g√∂nd…ôrm…ô
            elements.sendGroupImageBtn.addEventListener('click', async () => {
                const file = elements.groupImageInput.files[0];
                const venueId = elements.venueId.value;
                if (!file || !venueId) {
                    return log('Z…ôhm…ôt olmasa, ≈ü…ôkil se√ßin v…ô bir m…ôkanda olun.', 'error');
                }

                elements.sendGroupImageBtn.disabled = true;
                log('Qrup ≈ü…ôkli Cloudinary-…ô y√ºkl…ônir...', 'sent');
                const formData = new FormData();
                formData.append('groupChatImage', file);

                try {
                    const response = await fetch(`${elements.serverUrl.value}/api/chat/group/upload-image`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${elements.authToken.value}` },
                        body: formData
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message);

                    log('≈û…ôkil y√ºkl…ôndi. Qrup mesajƒ± g√∂nd…ôrilir...', 'sent');
                    socket.emit('send_venue_group_message', {
                        venueId: Number(venueId),
                        imageUrl: result.url
                    });
                    elements.groupImageInput.value = '';
                } catch (error) {
                    log(`Qrup ≈ü…ôkli g√∂nd…ôril…ôrk…ôn x…ôta: ${error.message}`, 'error');
                } finally {
                    elements.sendGroupImageBtn.disabled = false;
                }
            });

            // D√úZ∆èLƒ∞≈û: S…ôsli mesaj g√∂nd…ôrm…ô
            elements.recordBtn.addEventListener('click', async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start();
                    audioChunks = [];
                    mediaRecorder.addEventListener("dataavailable", event => {
                        audioChunks.push(event.data);
                    });

                    elements.recordBtn.style.display = 'none';
                    elements.stopBtn.style.display = 'block';
                    log('S…ôs yazƒ±lƒ±r...', 'received');
                } catch (err) {
                    log('Mikrofona icaz…ô verilm…ôdi v…ô ya x…ôta ba≈ü verdi.', 'error');
                }
            });

            // D√úZ∆èLƒ∞≈û: S…ôs yazma bit…ônd…ô
            elements.stopBtn.addEventListener('click', () => {
                mediaRecorder.addEventListener("stop", async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    elements.audioPlayer.src = audioUrl;
                    elements.audioPlayer.style.display = 'block';

                    const formData = new FormData();
                    formData.append('chatAudio', audioBlob, 'voice-message.mp3');

                    try {
                        const response = await fetch(`${elements.serverUrl.value}/api/chat/upload-audio`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${elements.authToken.value}` },
                            body: formData
                        });
                        const result = await response.json();
                        if (!response.ok) throw new Error(result.message);

                        socket.emit('send_message', {
                            connectionId: currentConnection.connection.id,
                            audioUrl: result.url
                        });
                    } catch (error) {
                        log(`S…ôsli mesaj g√∂nd…ôril…ôrk…ôn x…ôta: ${error.message}`, 'error');
                    }
                });
                mediaRecorder.stop();
                elements.recordBtn.style.display = 'block';
                elements.stopBtn.style.display = 'none';
                log('S…ôs yazma dayandƒ±rƒ±ldƒ±, fayl g√∂nd…ôrilir...', 'sent');
            });
        });
    </script>
</body>

</html>